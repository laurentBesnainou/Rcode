{
    "collab_server" : "",
    "contents" : "#lecture des fichiers de pipe depuis le debut de l'année\n\nlibrary(readxl)\nlibrary(xlsx)\nlibrary(tidyr)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(stringr)\nlibrary(readr)\nlibrary(lubridate) # gestion des dates\n\n############################## Pipe 2017 #############################################\nsetwd(\"D:/tmp/importDashbardData\")\n# on parcours le repertoire et on constitu un CSV avec toutes les donn?es\nfilenames <- list.files(path = \"input\", pattern = \"data_pilotage_S\")\nlstFile <- list.files(path = \"input\", pattern = \"data_pilotage_S\", full.names = TRUE)\nAjouteSemaine <- function(fichier){\n        pilotage_data_tmp <- read_excel(fichier, col_types = c(\n                                                rep(\"text\", 6),\n                                                \"numeric\",\n                                                rep(\"text\", 2),\n                                                rep(\"numeric\", 6),\n                                                \"text\",\n                                                \"date\",\n                                                rep(\"text\", 3),\n                                                rep(\"numeric\", 2),\n                                                rep(\"date\", 5)))\n        nb <- str_sub(fichier,22)\n        fin <- str_locate(nb,\".xlsx\")[1]\n        nb <-  as.numeric(str_sub(nb,1,fin-1))\n        #on ajoute la semaine et aussi la date de début de la semaine\n        date_ref <- data_frame(\n          date_ref = seq(from = dmy(\"01/01/2017\"), to = dmy(\"31/12/2017\"), by = \"weeks\"),\n          week = week(date_ref)\n        )\n        pilotage_data_tmp %>% mutate(week=nb) -> pilotage_data_tmp\n        pilotage_data_tmp %>% \n        inner_join(date_ref, by = \"week\")\n}\n\n# constitution d'un data frame vide\npilotage_data <- data.frame()\n\n# on charge tous les fichier Excel\nfor (i in lstFile) {\n  pilotage_data_temp <- AjouteSemaine(i)\n  pilotage_data <- bind_rows(pilotage_data,pilotage_data_temp)\n  print(i)\n}\n\nformat_col_names <- function(x) { \n  x <- str_replace_all(x, \"[éèê]\", \"e\")\n  x <- str_replace_all(x, \" \", \"_\")\n  x <- str_replace_all(x, \"\\\\.\", \"\")\n  x <- str_replace_all(x, \"/\", \"\")\n  x <- str_replace_all(x, \"€\", \"E\")\n  x <- str_replace_all(x, \"\\\\(\", \"_\")\n  x <- str_replace_all(x, \"\\\\)\", \"\")\n  x <- str_replace_all(x, \"\\n\", \"\")\n  x <- str_replace_all(x, \"\\r\", \"\")\n  x <- str_replace_all(x, \"\\\\+1\", \"_PLUS_1_\")\n  x <- str_replace_all(x, \"\\\\-1\", \"_MOINS_1_\")\n  x <- str_to_upper(x)\n  x\n}\n\ntrim <- function (x) gsub(\"^\\\\s+|\\\\s+$\", \"\", x)\n\ncolnames(pilotage_data) <- format_col_names(colnames(pilotage_data))\n\npilotage_data$`ANO-MALIES__12` <- NULL\npilotage_data$DATE_DERNIERE_MODIF <- NULL\n# on retire les blancs inutiles sur les groupes qui peuvent causer des erreurs de group_by\npilotage_data$GROUPE <- trim(pilotage_data$GROUPE)\npilotage_data$COMPTE[pilotage_data$COMPTE ==\"La poste\"] = \"La Poste\"\nsave(pilotage_data,file=\"pilotage_data.RData\")\n\n\n\n\n\npilotage2016_data <-pilotage_data\nsave(pilotage2016_data,file=\"pilotage2016_data.RData\")\nwrite_csv(pilotage_data, \"input/pilotage_clean_All.csv\")\n\n###############################\n# On importe les données 2015 PIPE #\n###############################\n######################\"\" 2015 ###########################\nformData <- c(\"date\", \"text\", \"text\", \n              \"text\", \"text\", \"text\", \"numeric\", \n              \"text\", \"text\", \"numeric\", \"numeric\", \"numeric\", \n              \"numeric\", \"numeric\", \"numeric\", \n              \"numeric\", \"numeric\", \"date\", \"date\", \n              \"text\", \"text\", \"text\", \"text\", \"text\", \n              \"date\", \"date\", \"date\", \n              \"date\", \"date\")\n\nsetwd(\"D:/Data/R sources/data_pilotage/input\")\n# on parcours le repertoire et on constitu un CSV avec toutes les donn?es\nfilenames <- list.files(path = \"2015\", pattern = \"data_pilotage_S\")\nlstFile <- list.files(path = \"2015\", pattern = \"data_pilotage_S\", full.names = TRUE)\nAjoute2015 <- function(fichier){\n  #on recupere le numero de la semaine\n  po <- regexpr('data_pilotage_S', fichier)\n  fin <- str_locate(fichier,\".xlsx\")[1]\n  semaine <- strtoi(str_sub(fichier,po+15,fin-1))\n  #Lecture du fichier\n  tmp <- read_excel(fichier, \n             col_types =formData)\n  \n  #on ajoute la semaine et aussi la date de début de la semaine\n  date_ref <- data_frame(\n    date_ref = seq(from = dmy(\"05/01/2015\"), to = dmy(\"31/12/2015\"), by = \"weeks\"),\n    week = week(date_ref)\n  )\n  #on ajoute la colonne semaine ainsi que la date correspondante sur 2015\n  tmp %>% mutate(week=semaine) %>% \n    inner_join(date_ref, by = \"week\")\n}\n  \n# constitution d'un data frame vide\npilotage2015_data <- data.frame()\n\n# on charge tous les fichier Excel\nfor (i in lstFile) {\n  pilotage_data_temp <- Ajoute2015(i)\n  pilotage2015_data <- bind_rows(pilotage2015_data,pilotage_data_temp)\n  print(i)\n}\n\ncolnames(pilotage2015_data) <- format_col_names(colnames(pilotage2015_data))\n\n#on va modifier des valeurs qui ne sont plus les même entre 2015 et 2016\npilotage2015_data$STEP[pilotage2015_data$STEP ==\"2 - Prop. à émettre\"] = \"2 - A émettre\"\npilotage2015_data$STEP[pilotage2015_data$STEP ==\"3 - Prop. émise\"] = \"3 - Emise\"\n\n# on retire les blancs inutiles sur les groupes qui peuvent causer des erreurs de group_by\npilotage2015_data$GROUPE <- trim(pilotage2015_data$GROUPE)\npilotage2015_data$GROUPE[pilotage2015_data$GROUPE ==\"La poste\"] = \"La Poste\"\n\n# \nsave(pilotage2015_data,file=\"pilotage2015_data1.RData\")\n\n\n############################## Staffing 2016 #############################################\n\nStaffing <- read_excel(\"input/staffing.xlsx\")\ncolnames(Staffing) <- format_col_names(colnames(Staffing))\nsave(Staffing,file=\"staffing2017.RData\")\nwrite_csv(Staffing, \"input/staffing.csv\")\nStaffingS10 <- read_excel(\"input/StaffingS10.xlsx\")\ncolnames(StaffingS10) <- format_col_names(colnames(StaffingS10))\nsave(StaffingS10,file=\"StaffingS10.RData\")\n\n\n\n\n############################## Staffing 2016 #############################################\nsetwd(\"D:/tmp/importDashbardData\")\nStaffing <- read_excel(\"input/StaffingS30.xlsx\")\ncolnames(Staffing) <- format_col_names(colnames(Staffing))\nsave(Effectifs2017,file=\"Effectif2017.RData\")\nsave(Effectifs2015,file=\"Effectif2015.RData\")\n\nsave(Staffing,file=\"staffing2017.RData\")\nwrite_csv(Staffing, \"input/staffing.csv\")\n\n############################## TOTEM 2013-2015 #############################################\nsetwd(\"D:/Data/R sources/data_pilotage\")\nTOTEM <- read_excel(\"input/TOTEM2013-2015.xlsx\")\ncolnames(TOTEM) <- format_col_names(colnames(TOTEM))\nsave(TOTEM,file=\"TOTEM.RData\")\npilotage2016_data <- pilo\nsave(pilotage2016_data,file=\"pilotage2016_data.RData\")\n",
    "created" : 1487524576801.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2011747229",
    "id" : "87BC5C56",
    "lastKnownWriteTime" : 1501084587,
    "last_content_update" : 1501084587667,
    "path" : "D:/tmp/importDashbardData/import_pipe_all.R",
    "project_path" : "import_pipe_all.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}